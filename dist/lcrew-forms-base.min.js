Object.defineProperty(exports,"__esModule",{value:!0});var React=require("react"),PropTypes=require("prop-types"),FormContext=React.createContext(null);function formComponentReducerInit(e){var r;return void 0===e&&(e="globalError"),{fields:[],values:{},defaultValues:{},errors:((r={})[e]=void 0,r),fieldActiveMap:{},isSubmitted:!1,formGlobalErrorName:e,dependenciesMap:{}}}function formComponentReducer(r,t){var e,n,o,u,a,i,c,l,s,d,v;switch(t.type){case"add":var f={name:t.name,validators:t.validators,valueFilter:t.valueFilter,validateOnBlur:t.validateOnBlur},m=Object.assign({},r.values,((e={})[t.name]=t.value,e)),p=Object.assign({},r.errors,((n={})[t.name]=void 0,n)),b=Object.assign({},r.defaultValues,((o={})[t.name]=t.value,o)),F=Object.assign({},r.fieldActiveMap,((u={})[t.name]=t.enabled,u)),R=r.fields.concat([f]),j=Object.assign({},r.dependenciesMap);return t.dependencies&&t.dependencies.forEach(function(e){var r;j[e]=Object.assign({},j[e],((r={})[t.name]=!0,r))}),Object.assign({},r,{fields:R,values:m,errors:p,dependenciesMap:j,fieldActiveMap:F,defaultValues:b});case"value":if(r.values[t.name]===t.value||t.condition&&!t.condition(r))return r;var C=Object.assign({},r.values,((a={})[t.name]=t.value,a)),O=Object.assign({},r.errors,((i={})[r.formGlobalErrorName]=void 0,i)),x=t.updateDefaultValue?Object.assign({},r.defaultValues,((c={})[t.name]=t.value,c)):r.defaultValues,y=r.fields.find(function(e){return e.name==t.name});if(y.validateOnBlur&&!O[t.name]||(O[t.name]=validateField(y,C,O,r.fieldActiveMap)),t.name in r.dependenciesMap){var g=r.dependenciesMap[t.name];r.fields.forEach(function(e){e.name in g&&(O[e.name]=validateField(e,C,O,r.fieldActiveMap))})}return Object.assign({},r,{values:C,errors:O,defaultValues:x});case"error":var S=Object.assign({},r.errors,((l={})[null!=t.name?t.name:r.formGlobalErrorName]=t.error,l));return Object.assign({},r,{errors:S});case"enable":if(r.fieldActiveMap[t.name]===t.value)return r;var A=Object.assign({},r.fieldActiveMap,((s={})[t.name]=t.value,s)),E=Object.assign({},r.errors,((d={})[t.name]=void 0,d));return Object.assign({},r,{fieldActiveMap:A,errors:E});case"validateAll":var h={};return h[r.formGlobalErrorName]=void 0,r.fields.forEach(function(e){return h[e.name]=validateField(e,r.values,r.errors,r.fieldActiveMap)}),Object.assign({},r,{errors:h});case"validate":var V=validateField(r.fields.find(function(e){return e.name==t.name}),r.values,r.errors,r.fieldActiveMap);if(V===r.errors[t.name])return r;var P=Object.assign({},r.errors,((v={})[t.name]=V,v));return Object.assign({},r,{errors:P});case"submit":var M={};M[r.formGlobalErrorName]=void 0,r.fields.forEach(function(e){return M[e.name]=validateField(e,r.values,r.errors,r.fieldActiveMap)});var T=Object.assign({},r,{errors:M});return T.isSubmitted=!hasErrors(T),T;case"finishSubmit":var w={};w[r.formGlobalErrorName]=void 0;var B=Object.assign({},r.values);if(t.errors)for(var q in t.errors){var G=t.errors[q];w["null"!==q&&"undefined"!==q?q:r.formGlobalErrorName]=!G||"string"==typeof G||G instanceof String?G:G.message}else t.clearFieldsAfterSubmit&&r.fields.forEach(function(e){B[e.name]=r.defaultValues[e.name]});return Object.assign({},r,{isSubmitted:!1,values:B,errors:w});default:throw new Error("formComponentReducer unknown action type: "+t.type)}}function getFormFilteredValues(t){return t.fields.reduce(function(e,r){return e[r.name]=getFieldValue(r,t.values[r.name]),e},{})}function hasErrors(e,r){var t=e.errors,n=e.formGlobalErrorName;return void 0===r&&(r=!1),!!t&&Object.keys(t).some(function(e){return!!t[e]&&(r||e!=n)})}function validateField(e,r,t,n){if(e.validators&&n[e.name]){var o=getFieldValue(e,r[e.name]);if(Array.isArray(e.validators)){var u=e.validators.find(function(e){return!e.func(o,r,t)});return u?u.message:void 0}return e.validators.func(o,r,t)?void 0:e.validators.message}}function getFieldValue(e,r){return e.valueFilter&&(r=e.valueFilter(r)),r}function FormComponent(e){var r=e.children,t=e.formSubmit,n=e.clearFieldsAfterSubmit,o=e.additionalContextProps,u=e.formGlobalErrorName;void 0===u&&(u="globalError");var a=React.useReducer(formComponentReducer,u,formComponentReducerInit),i=a[0],c=a[1],l=React.useMemo(function(){return[i,c,o]},[i,o]);return React.useEffect(function(){var r=!0;if(i.isSubmitted){var e=getFormFilteredValues(i);t(e).then(function(e){r&&c({type:"finishSubmit",clearFieldsAfterSubmit:n,errors:e})})}return function(){return r=!1}},[i.isSubmitted,n]),React.createElement(FormContext.Provider,{value:l},r)}var FormComponent$1=React.memo(FormComponent);function useFormContext(){return React.useContext(FormContext)}function useFormContextError(e){var r=React.useContext(FormContext)[0];return r.errors[e||r.formGlobalErrorName]}function useFormContextValue(e){return React.useContext(FormContext)[0].values[e]}function useFormContextEnabled(e){return React.useContext(FormContext)[0].fieldActiveMap[e]}function useFormField(e){var r=e.name,t=e.validators,n=e.valueFilter,o=e.dependencies,u=e.value,a=e.refreshValue,i=e.validateOnBlur,c=e.fieldEnabled,l=useFormContext(),s=l[0],d=l[1],v=l[2];return React.useEffect(function(){d({type:"add",name:r,value:u,validators:t,valueFilter:n,dependencies:o,validateOnBlur:i,enabled:c})},[]),React.useEffect(function(){a&&d({type:"value",name:r,value:u,updateDefaultValue:!0})},[u,a]),[void 0!==s.values[r]?s.values[r]:u,s.errors[r],void 0!==s.fieldActiveMap[r]?s.fieldActiveMap[r]:c,d,v]}FormComponent.propTypes={formSubmit:PropTypes.func.isRequired,clearFieldsAfterSubmit:PropTypes.bool,additionalContextProps:PropTypes.object,formGlobalErrorName:PropTypes.string};var getMergedProps=function(e,n){return Object.keys(n).reduce(function(e,r){var t=n[r];return void 0!==t&&(e[r]=t),e},Object.assign({},e))};function FormFieldComponent(e){var r=useFormField(e),t=r[0],n=r[1],o=r[2],u=r[3],a=r[4],i=React.useState(void 0),c=i[0],l=i[1],s=e.name,d=e.onBlur,v=e.validateOnBlur,f=e.Template,m=React.useCallback(function(e){u({type:"value",name:s,value:e})},[s]),p=React.useCallback(function(){v?(u({type:"validate",name:s}),d&&l((c||0)+1)):d&&d(s,t,n,u)},[s,t,n]);React.useEffect(function(){void 0!==c&&d(s,t,n,u)},[c]);var b=f||a.Template,F=getMergedProps(a,e);return React.createElement(b,Object.assign({},F,{value:t,error:n,fieldEnabled:o,dispatch:u,onBlur:p,changeValue:m}))}function useFormSubmit(){var e=useFormContext(),r=e[0],t=e[1],n=e[2],o=r.isSubmitted;return[o,o||hasErrors(r),t,n]}function objectWithoutProperties(e,r){var t={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&-1===r.indexOf(n)&&(t[n]=e[n]);return t}function FormFieldSubmitComponent(e){var r=e.Template,t=e.disabled,n=objectWithoutProperties(e,["Template","disabled"]),o=useFormSubmit(),u=o[0],a=o[1],i=o[2],c=o[3],l=React.useCallback(function(){return i({type:"submit"})},[]),s=r||c.SubmitTemplate,d=getMergedProps(c,n);return React.createElement(s,Object.assign({},d,{onSubmit:l,isSubmitted:u,disabled:a||t,dispatch:i}))}var emptyArray=[];function useAutocomplete(r,n,o,u,t,a,i,c){var e=React.useState(""),l=e[0],s=e[1],d=React.useState(void 0),v=d[0],f=d[1],m=React.useMemo(function(){return(r||emptyArray).reduce(function(e,r){return e[u(r)]=r,e},{})},[r]);React.useEffect(function(){var e=n.filter(function(e){return e in m});n.length<e.length&&o(e)},[r]),React.useEffect(function(){if(l){var e=setTimeout(function(){var e=t(r||emptyArray,l);e=e&&e.filter(function(e){return!n.includes(u(e))}).slice(0,i),f(e)},a);return function(){return clearTimeout(e)}}f(emptyArray)},[r,l]);var p=React.useCallback(function(e){var r=u(e);if(!n.some(function(e){return e===r})&&(!c||n.length<c)){var t=n.concat([r]);s(""),o(t)}},[n]),b=React.useCallback(function(e){var r=u(e),t=n.filter(function(e){return e!==r});s(""),o(t)},[n]),F=React.useCallback(function(e){s(e)},[]);return[v,l,F,p,b,m]}exports.Form=FormComponent$1,exports.FormField=FormFieldComponent,exports.FormFieldSubmit=FormFieldSubmitComponent,exports.useAutocomplete=useAutocomplete,exports.useFormContext=useFormContext,exports.useFormContextEnabled=useFormContextEnabled,exports.useFormContextError=useFormContextError,exports.useFormContextValue=useFormContextValue,exports.useFormField=useFormField,exports.useFormSubmit=useFormSubmit;
