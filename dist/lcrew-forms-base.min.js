Object.defineProperty(exports,"__esModule",{value:!0});var React=require("react"),PropTypes=require("prop-types"),FormContext=React.createContext(null);function formComponentReducerInit(e){var r;return void 0===e&&(e="globalError"),{fields:[],values:{},errors:((r={})[e]=void 0,r),fieldActiveMap:{},isSubmitted:!1,formGlobalErrorName:e,dependenciesMap:{}}}function formComponentReducer(r,t){var e,n,o,u,i,a,c,l,s;switch(t.type){case"add":var d={name:t.name,validators:t.validators,defaultValue:t.value,valueFilter:t.valueFilter,validateOnBlur:t.validateOnBlur},v=Object.assign({},r.values,((e={})[t.name]=t.value,e)),m=Object.assign({},r.errors,((n={})[t.name]=void 0,n)),f=Object.assign({},r.fieldActiveMap,((o={})[t.name]=t.enabled,o)),p=r.fields.concat([d]),b=Object.assign({},r.dependenciesMap);return t.dependencies&&t.dependencies.forEach(function(e){var r;b[e]=Object.assign({},b[e],((r={})[t.name]=!0,r))}),Object.assign({},r,{fields:p,values:v,errors:m,dependenciesMap:b,fieldActiveMap:f});case"value":if(r.values[t.name]===t.value||t.condition&&!t.condition(r))return r;var F=Object.assign({},r.values,((u={})[t.name]=t.value,u)),C=Object.assign({},r.errors,((i={})[r.formGlobalErrorName]=void 0,i)),R=r.fields.find(function(e){return e.name==t.name});if(R.validateOnBlur&&!C[t.name]||(C[t.name]=validateField(R,F,C,r.fieldActiveMap)),t.name in r.dependenciesMap){var j=r.dependenciesMap[t.name];r.fields.forEach(function(e){e.name in j&&(C[e.name]=validateField(e,F,C,r.fieldActiveMap))})}return Object.assign({},r,{values:F,errors:C});case"error":var O=Object.assign({},r.errors,((a={})[null!=t.name?t.name:r.formGlobalErrorName]=t.error,a));return Object.assign({},r,{errors:O});case"enable":if(r.fieldActiveMap[t.name]===t.value)return r;var x=Object.assign({},r.fieldActiveMap,((c={})[t.name]=t.value,c)),y=Object.assign({},r.errors,((l={})[t.name]=void 0,l));return Object.assign({},r,{fieldActiveMap:x,errors:y});case"validateAll":var g={};return g[r.formGlobalErrorName]=void 0,r.fields.forEach(function(e){return g[e.name]=validateField(e,r.values,r.errors,r.fieldActiveMap)}),Object.assign({},r,{errors:g});case"validate":var S=validateField(r.fields.find(function(e){return e.name==t.name}),r.values,r.errors,r.fieldActiveMap);if(S===r.errors[t.name])return r;var A=Object.assign({},r.errors,((s={})[t.name]=S,s));return Object.assign({},r,{errors:A});case"submit":var E={};E[r.formGlobalErrorName]=void 0,r.fields.forEach(function(e){return E[e.name]=validateField(e,r.values,r.errors,r.fieldActiveMap)});var h=Object.assign({},r,{errors:E});return h.isSubmitted=!hasErrors(h),h;case"finishSubmit":var P={};P[r.formGlobalErrorName]=void 0;var M=Object.assign({},r.values);if(t.errors)for(var V in t.errors){var T=t.errors[V];P["null"!==V&&"undefined"!==V?V:r.formGlobalErrorName]=!T||"string"==typeof T||T instanceof String?T:T.message}else t.clearFieldsAfterSubmit&&r.fields.forEach(function(e){M[e.name]=e.defaultValue});return Object.assign({},r,{isSubmitted:!1,values:M,errors:P});default:throw new Error("formComponentReducer unknown action type: "+t.type)}}function getFormFilteredValues(t){return t.fields.reduce(function(e,r){return e[r.name]=getFieldValue(r,t.values[r.name]),e},{})}function hasErrors(e,r){var t=e.errors,n=e.formGlobalErrorName;return void 0===r&&(r=!1),!!t&&Object.keys(t).some(function(e){return!!t[e]&&(r||e!=n)})}function validateField(e,r,t,n){if(e.validators&&n[e.name]){var o=getFieldValue(e,r[e.name]);if(Array.isArray(e.validators)){var u=e.validators.find(function(e){return!e.func(o,r,t)});return u?u.message:void 0}return e.validators.func(o,r,t)?void 0:e.validators.message}}function getFieldValue(e,r){return e.valueFilter&&(r=e.valueFilter(r)),r}function FormComponent(e){var r=e.children,t=e.formSubmit,n=e.clearFieldsAfterSubmit,o=e.additionalContextProps,u=e.formGlobalErrorName;void 0===u&&(u="globalError");var i=React.useReducer(formComponentReducer,u,formComponentReducerInit),a=i[0],c=i[1],l=React.useMemo(function(){return[a,c,o]},[a,o]);return React.useEffect(function(){var r=!0;if(a.isSubmitted){var e=getFormFilteredValues(a);t(e).then(function(e){r&&c({type:"finishSubmit",clearFieldsAfterSubmit:n,errors:e})})}return function(){return r=!1}},[a.isSubmitted,n]),React.createElement(FormContext.Provider,{value:l},r)}var FormComponent$1=React.memo(FormComponent);function useFormContext(){return React.useContext(FormContext)}function useFormContextError(e){var r=React.useContext(FormContext)[0];return r.errors[e||r.formGlobalErrorName]}function useFormContextValue(e){return React.useContext(FormContext)[0].values[e]}function useFormContextEnabled(e){return React.useContext(FormContext)[0].fieldActiveMap[e]}function useFormField(e){var r=e.name,t=e.validators,n=e.valueFilter,o=e.dependencies,u=e.validateOnBlur,i=e.value,a=e.fieldEnabled,c=useFormContext(),l=c[0],s=c[1],d=c[2];return React.useEffect(function(){s({type:"add",name:r,value:i,validators:t,valueFilter:n,dependencies:o,validateOnBlur:u,enabled:a})},[]),[void 0!==l.values[r]?l.values[r]:i,l.errors[r],void 0!==l.fieldActiveMap[r]?l.fieldActiveMap[r]:a,s,d]}FormComponent.propTypes={formSubmit:PropTypes.func.isRequired,clearFieldsAfterSubmit:PropTypes.bool,additionalContextProps:PropTypes.object,formGlobalErrorName:PropTypes.string};var getMergedProps=function(e,n){return Object.keys(n).reduce(function(e,r){var t=n[r];return void 0!==t&&(e[r]=t),e},Object.assign({},e))};function FormFieldComponent(e){var r=useFormField(e),t=r[0],n=r[1],o=r[2],u=r[3],i=r[4],a=e.name,c=e.onBlur,l=e.validateOnBlur,s=e.Template,d=React.useCallback(function(e){u({type:"value",name:a,value:e})},[a]),v=React.useCallback(function(){l&&u({type:"validate",name:a}),c&&c(a,t,n,u)},[a,t,n]),m=s||i.Template,f=getMergedProps(i,e);return React.createElement(m,Object.assign({},f,{value:t,error:n,fieldEnabled:o,dispatch:u,onBlur:v,changeValue:d}))}function useFormSubmit(){var e=useFormContext(),r=e[0],t=e[1],n=e[2],o=r.isSubmitted;return[o,o||hasErrors(r),t,n]}function objectWithoutProperties(e,r){var t={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&-1===r.indexOf(n)&&(t[n]=e[n]);return t}function FormFieldSubmitComponent(e){var r=e.Template,t=e.disabled,n=objectWithoutProperties(e,["Template","disabled"]),o=useFormSubmit(),u=o[0],i=o[1],a=o[2],c=o[3],l=React.useCallback(function(){return a({type:"submit"})},[]),s=r||c.SubmitTemplate,d=getMergedProps(c,n);return React.createElement(s,Object.assign({},d,{onSubmit:l,isSubmitted:u,disabled:i||t,dispatch:a}))}var emptyArray=[];function useAutocomplete(r,n,o,u,t,i,a,c){var e=React.useState(""),l=e[0],s=e[1],d=React.useState(void 0),v=d[0],m=d[1],f=React.useMemo(function(){return(r||emptyArray).reduce(function(e,r){return e[u(r)]=r,e},{})},[r]);React.useEffect(function(){var e=n.filter(function(e){return e in f});n.length<e.length&&o(e)},[r]),React.useEffect(function(){if(l){var e=setTimeout(function(){var e=t(r||emptyArray,l);e=e&&e.filter(function(e){return!n.includes(u(e))}).slice(0,a),m(e)},i);return function(){return clearTimeout(e)}}m(emptyArray)},[r,l]);var p=React.useCallback(function(e){var r=u(e);if(!n.some(function(e){return e===r})&&(!c||n.length<c)){var t=n.concat([r]);s(""),o(t)}},[n]),b=React.useCallback(function(e){var r=u(e),t=n.filter(function(e){return e!==r});s(""),o(t)},[n]),F=React.useCallback(function(e){s(e)},[]);return[v,l,F,p,b,f]}exports.Form=FormComponent$1,exports.FormField=FormFieldComponent,exports.FormFieldSubmit=FormFieldSubmitComponent,exports.useAutocomplete=useAutocomplete,exports.useFormContext=useFormContext,exports.useFormContextEnabled=useFormContextEnabled,exports.useFormContextError=useFormContextError,exports.useFormContextValue=useFormContextValue,exports.useFormField=useFormField,exports.useFormSubmit=useFormSubmit;
