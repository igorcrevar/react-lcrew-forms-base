Object.defineProperty(exports,"__esModule",{value:!0});var React=require("react"),PropTypes=require("prop-types"),FormContext=React.createContext(null);function formComponentReducerInit(e){var r;return void 0===e&&(e="globalError"),{fields:[],values:{},errors:((r={})[e]=void 0,r),fieldActiveMap:{},isSubmitted:!1,formGlobalErrorName:e,dependenciesMap:{}}}function formComponentReducer(r,t){var e,n,o,u,a,i,c,l,s;switch(t.type){case"add":var v={name:t.name,validators:t.validators,defaultValue:t.value,valueFilter:t.valueFilter,validateOnBlur:t.validateOnBlur},d=Object.assign({},r.values,((e={})[t.name]=t.value,e)),f=Object.assign({},r.errors,((n={})[t.name]=void 0,n)),m=Object.assign({},r.fieldActiveMap,((o={})[t.name]=t.enabled,o)),p=r.fields.concat([v]),F=Object.assign({},r.dependenciesMap);return t.dependencies&&t.dependencies.forEach(function(e){var r;F[e]=Object.assign({},F[e],((r={})[t.name]=!0,r))}),Object.assign({},r,{fields:p,values:d,errors:f,dependenciesMap:F,fieldActiveMap:m});case"value":if(r.values[t.name]===t.value||t.condition&&!t.condition(r))return r;var b=Object.assign({},r.values,((u={})[t.name]=t.value,u)),C=Object.assign({},r.errors,((a={})[r.formGlobalErrorName]=void 0,a)),x=r.fields.find(function(e){return e.name==t.name});if(x.validateOnBlur&&!C[t.name]||(C[t.name]=validateField(x,b,C,r.fieldActiveMap)),t.name in r.dependenciesMap){var R=r.dependenciesMap[t.name];r.fields.forEach(function(e){e.name in R&&(C[e.name]=validateField(e,b,C,r.fieldActiveMap))})}return Object.assign({},r,{values:b,errors:C});case"error":var O=Object.assign({},r.errors,((i={})[null!=t.name?t.name:r.formGlobalErrorName]=t.error,i));return Object.assign({},r,{errors:O});case"enable":if(r.fieldActiveMap[t.name]===t.value)return r;var j=Object.assign({},r.fieldActiveMap,((c={})[t.name]=t.value,c)),y=Object.assign({},r.errors,((l={})[t.name]=void 0,l));return Object.assign({},r,{fieldActiveMap:j,errors:y});case"validateAll":var A={};return A[r.formGlobalErrorName]=void 0,r.fields.forEach(function(e){return A[e.name]=validateField(e,r.values,r.errors,r.fieldActiveMap)}),Object.assign({},r,{errors:A});case"validate":var E=validateField(r.fields.find(function(e){return e.name==t.name}),r.values,r.errors,r.fieldActiveMap);if(E===r.errors[t.name])return r;var S=Object.assign({},r.errors,((s={})[t.name]=E,s));return Object.assign({},r,{errors:S});case"submit":var g={};g[r.formGlobalErrorName]=void 0,r.fields.forEach(function(e){return g[e.name]=validateField(e,r.values,r.errors,r.fieldActiveMap)});var h=Object.assign({},r,{errors:g});return h.isSubmitted=!hasErrors(h),h;case"finishSubmit":var V={};V[r.formGlobalErrorName]=void 0;var M=Object.assign({},r.values);if(t.errors)for(var T in t.errors){var P=t.errors[T];V["null"!==T&&"undefined"!==T?T:r.formGlobalErrorName]=!P||"string"==typeof P||P instanceof String?P:P.message}else t.clearFieldsAfterSubmit&&r.fields.forEach(function(e){M[e.name]=e.defaultValue});return Object.assign({},r,{isSubmitted:!1,values:M,errors:V});default:throw new Error("formComponentReducer unknown action type: "+t.type)}}function getFormFilteredValues(t){return t.fields.reduce(function(e,r){return e[r.name]=getFieldValue(r,t.values[r.name]),e},{})}function hasErrors(e,r){var t=e.errors,n=e.formGlobalErrorName;return void 0===r&&(r=!1),!!t&&Object.keys(t).some(function(e){return!!t[e]&&(r||e!=n)})}function validateField(e,r,t,n){if(e.validators&&n[e.name]){var o=getFieldValue(e,r[e.name]);if(Array.isArray(e.validators)){var u=e.validators.find(function(e){return!e.func(o,r,t)});return u?u.message:void 0}return e.validators.func(o,r,t)?void 0:e.validators.message}}function getFieldValue(e,r){return e.valueFilter&&(r=e.valueFilter(r)),r}function FormComponent(e){var r=e.children,t=e.formSubmit,n=e.clearFieldsAfterSubmit,o=e.additionalContextProps,u=React.useReducer(formComponentReducer,e.formGlobalErrorName,formComponentReducerInit),a=u[0],i=u[1];return React.useEffect(function(){var r=!0;if(a.isSubmitted){var e=getFormFilteredValues(a);return t(e).then(function(e){r&&i({type:"finishSubmit",clearFieldsAfterSubmit:n,errors:e})}),function(){return r=!1}}},[a.isSubmitted]),React.createElement(FormContext.Provider,{value:o?[a,i,o]:u},r)}var FormComponent$1=React.memo(FormComponent);function useFormContext(){return React.useContext(FormContext)}function useFormContextError(e){var r=React.useContext(FormContext)[0];return r.errors[e||r.formGlobalErrorName]}function useFormContextValue(e){return React.useContext(FormContext)[0].values[e]}function useFormContextEnabled(e){return React.useContext(FormContext)[0].fieldActiveMap[e]}function useFormField(e){var r=e.name,t=e.validators,n=e.valueFilter,o=e.dependencies,u=e.validateOnBlur,a=e.value,i=e.fieldEnabled,c=useFormContext(),l=c[0],s=c[1],v=c[2];return React.useEffect(function(){s({type:"add",name:r,value:a,validators:t,valueFilter:n,dependencies:o,validateOnBlur:u,enabled:i})},[]),[void 0!==l.values[r]?l.values[r]:a,l.errors[r],void 0!==l.fieldActiveMap[r]?l.fieldActiveMap[r]:i,s,v]}function FormFieldComponent(e){var r=useFormField(e),t=r[0],n=r[1],o=r[2],u=r[3],a=r[4],i=e.name,c=e.onBlur,l=e.validateOnBlur,s=e.Template,v=React.useCallback(function(e){u({type:"value",name:i,value:e})},[i]),d=React.useCallback(function(){l&&u({type:"validate",name:i}),c&&c(i,t,n,u)},[i,t,n]);return React.createElement(s,Object.assign({},e,a,{value:t,error:n,fieldEnabled:o,dispatch:u,onBlur:d,changeValue:v}))}function useFormSubmit(){var e=useFormContext(),r=e[0],t=e[1],n=e[2],o=r.isSubmitted;return[o,o||hasErrors(r),t,n]}FormComponent.propTypes={formSubmit:PropTypes.func.isRequired,clearFieldsAfterSubmit:PropTypes.bool,additionalContextProps:PropTypes.object};var emptyArray=[];function useAutocomplete(r,n,o,u,t,a,i,c){var e=React.useState(""),l=e[0],s=e[1],v=React.useState(void 0),d=v[0],f=v[1],m=React.useMemo(function(){return(r||emptyArray).reduce(function(e,r){return e[u(r)]=r,e},{})},[r]);React.useEffect(function(){var e=n.filter(function(e){return e in m});n.length<e.length&&o(e)},[r]),React.useEffect(function(){if(l){var e=setTimeout(function(){var e=t(r||emptyArray,l);e=e&&e.filter(function(e){return!n.includes(u(e))}).slice(0,i),f(e)},a);return function(){return clearTimeout(e)}}f(emptyArray)},[r,l]);var p=React.useCallback(function(e){var r=u(e);if(!n.some(function(e){return e===r})&&(!c||n.length<c)){var t=n.concat([r]);s(""),o(t)}},[n]),F=React.useCallback(function(e){var r=u(e),t=n.filter(function(e){return e!==r});s(""),o(t)},[n]),b=React.useCallback(function(e){s(e)},[]);return[d,l,b,p,F,m]}exports.Form=FormComponent$1,exports.FormField=FormFieldComponent,exports.useAutocomplete=useAutocomplete,exports.useFormContext=useFormContext,exports.useFormContextEnabled=useFormContextEnabled,exports.useFormContextError=useFormContextError,exports.useFormContextValue=useFormContextValue,exports.useFormField=useFormField,exports.useFormSubmit=useFormSubmit;
